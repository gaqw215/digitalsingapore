<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Nation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --sg-red: #ef233c;
        }

        .sg-card {
            background: #fff;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #fee2e2;
            box-shadow: 0 5px 12px rgba(0, 0, 0, .08);
        }

        .caption a {
            color: #1d4ed8;
            text-decoration: underline
        }

        html {
            scroll-behavior: smooth
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin: 2rem 0
        }

        .stat-card {
            background: white;
            padding: 1.25rem;
            border-radius: .75rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .1);
            border-top: 4px solid var(--sg-red)
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--sg-red)
        }

        .stat-label {
            color: #4b5563;
            font-weight: 500
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
            margin: 1.5rem 0
        }

        .feature-card {
            background: #f8fafc;
            padding: 1rem;
            border-radius: .75rem;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 4px 8px rgba(0, 0, 0, .08)
        }

        @media (max-width:768px) {

            .stat-grid,
            .feature-grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans">

    <!-- NAV -->
    <nav id="nav" class="bg-[var(--sg-red)] text-white p-4 shadow-md relative z-50"></nav>

    <!-- Header -->
    <header class="bg-[var(--sg-red)] text-white p-6 shadow-lg">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-3xl font-extrabold tracking-tight" id="site-title">Loading...</h1>
            <p class="mt-2 text-lg opacity-95" id="site-subtitle"></p>
        </div>
    </header>

    <!-- Main -->
    <main class="max-w-6xl mx-auto p-4 sm:p-6" id="content"></main>

    <!-- Footer -->
    <footer class="bg-gray-100 text-center p-6 text-sm text-gray-600" id="footer"></footer>

    <!-- Validator -->
    <script src="validator.js"></script>
    <script>
        /* ---------------- schema for smartnation.json ---------------- */
        const citationObj = {
            type: 'object', required: ['url'], properties: {
                url: { type: 'string' }, text: { type: 'string', optional: true }, name: { type: 'string', optional: true }
            }
        };

        const anyChartSchema = {
            anyOf: [
                {
                    type: 'object', required: ['labels', 'data'], properties: {
                        labels: { type: 'array', items: { type: 'string' } },
                        data: { type: 'array', items: { type: 'number' } },
                        label: { type: 'string', optional: true },
                        yUnit: { type: 'string', optional: true }, y1Unit: { type: 'string', optional: true },
                        sources: { type: 'array', items: citationObj, optional: true }
                    }
                },
                {
                    type: 'object', required: ['labels', 'datasets'], properties: {
                        labels: { type: 'array', items: { type: 'string' } },
                        datasets: {
                            type: 'array', minItems: 1, items: {
                                type: 'object', required: ['data'], properties: {
                                    label: { type: 'string', optional: true }, data: { type: 'array', items: { type: 'number' } },
                                    type: { type: 'string', optional: true }, yAxis: { type: 'string', optional: true },
                                    borderColor: { type: 'string', optional: true }, backgroundColor: { type: 'string', optional: true }
                                }
                            }
                        },
                        yUnit: { type: 'string', optional: true }, y1Unit: { type: 'string', optional: true },
                        sources: { type: 'array', items: citationObj, optional: true }
                    }
                }
            ]
        };

        const imageSchema = {
            type: 'object', required: ['src'],
            properties: {
                src: { type: 'string' }, alt: { type: 'string', optional: true }, caption: { type: 'string', optional: true },
                source: { type: 'object', optional: true, required: ['url'], properties: { url: { type: 'string' }, text: { type: 'string', optional: true }, name: { type: 'string', optional: true } } }
            }
        };

        const sectionSchema = {
            type: 'object', required: ['title'],
            properties: {
                title: { type: 'string' },
                paragraphs: { type: 'array', items: { type: 'string' } },
                image: imageSchema,
                milestones: { type: 'array', items: { type: 'string' } },
                stats: { type: 'array', items: { type: 'object', required: ['label', 'value'], properties: { label: { type: 'string' }, value: { type: 'string' } } } },
                features: { type: 'array', items: { type: 'object', required: ['title', 'items'], properties: { title: { type: 'string' }, items: { type: 'array', items: { type: 'string' } } } } },
                chart: anyChartSchema,
                impact: {
                    type: 'object', optional: true, properties: {
                        title: { type: 'string', optional: true }, text: { type: 'string', optional: true },
                        achievements: { type: 'array', items: { type: 'string' }, optional: true },
                        source: { type: 'object', optional: true, properties: { url: { type: 'string' }, text: { type: 'string' }, name: { type: 'string' } } }
                    }
                },
                recognition: {
                    type: 'object', optional: true, properties: {
                        title: { type: 'string', optional: true }, text: { type: 'string', optional: true },
                        source: { type: 'object', optional: true, properties: { url: { type: 'string' }, text: { type: 'string' }, name: { type: 'string' } } }
                    }
                },
                sources: { type: 'array', items: citationObj, optional: true }
            }
        };

        const smartNationSchema = {
            type: 'object', required: ['nav', 'site', 'sections'],
            properties: {
                nav: {
                    type: 'object', required: ['title', 'links'], properties: {
                        title: { type: 'string' },
                        links: { type: 'array', items: { type: 'object', required: ['name', 'url'], properties: { name: { type: 'string' }, url: { type: 'string' }, active: { type: 'boolean', optional: true } } } }
                    }
                },
                site: {
                    type: 'object', required: ['title', 'subtitle', 'footer'], properties: {
                        title: { type: 'string' }, subtitle: { type: 'string' }, footer: { type: 'string' }
                    }
                },
                timeline: {
                    type: 'object', optional: true, required: ['title', 'events'], properties: {
                        title: { type: 'string' },
                        events: { type: 'array', items: { type: 'object', required: ['year', 'title'], properties: { id: { type: 'string', optional: true }, year: { type: 'string' }, title: { type: 'string' } } } },
                        sources: { type: 'array', items: citationObj, optional: true }
                    }
                },
                sections: { type: 'object', custom: (obj) => Object.keys(obj).length ? '' : 'sections object is empty.' },
                gallery: {
                    type: 'object', optional: true, properties: {
                        title: { type: 'string', optional: true },
                        images: { type: 'array', items: imageSchema, optional: true }
                    }
                }
            }
        };

        /* ---------------- helpers (shared with section1 style) ---------------- */
        function renderNav(navData) {
            const nav = document.getElementById('nav');
            nav.innerHTML = `
        <div class="max-w-6xl mx-auto flex items-center justify-between">
          <a href="index.html" class="font-bold text-xl">${navData.title}</a>
          <button id="menu-btn" class="sm:hidden p-2 rounded focus:outline-none" aria-expanded="false" aria-controls="menu" aria-label="Toggle menu">â˜°</button>
          <ul id="menu" class="hidden sm:flex gap-6 absolute sm:static top-full left-0 right-0 bg-[var(--sg-red)] sm:bg-transparent flex-col sm:flex-row p-4 sm:p-0 shadow-md sm:shadow-none">
            ${navData.links.map(l => `<li><a href="${l.url}" class="block py-2 sm:py-0 ${l.active ? 'underline' : 'hover:underline'}">${l.name}</a></li>`).join('')}
          </ul>
        </div>`;
            const btn = nav.querySelector('#menu-btn');
            const menu = nav.querySelector('#menu');
            btn?.addEventListener('click', () => {
                const expanded = btn.getAttribute('aria-expanded') === 'true';
                btn.setAttribute('aria-expanded', String(!expanded));
                menu.classList.toggle('hidden');
            });
            menu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => {
                if (window.innerWidth < 640) { menu.classList.add('hidden'); btn?.setAttribute('aria-expanded', 'false'); }
            }));
        }

        // normalise label for sources (supports .text or .name)
        function labelFrom(src) { return (src && (src.text || src.name)) ? (src.text || src.name) : 'source'; }

        // render list of sources
        function srcLinks(arr) {
            return (arr || [])
                .map(s => `<a class="underline" target="_blank" rel="noopener" href="${s?.url || '#'}">${labelFrom(s)}</a>`)
                .join(' â€¢ ');
        }

        function renderImageFigure(img) {
            if (img?.src) {
                const src = img.src;
                const cap = img.caption || '';
                const srcHtml = img.source ? ` <span class="text-xs text-gray-500 italic">Source: <a class="underline" href="${img.source.url}" target="_blank" rel="noopener">${labelFrom(img.source)}</a></span>` : '';
                return `
          <figure class="mt-4">
            <img src="${src}" alt="${img.alt || ''}" class="w-full h-auto object-contain rounded-xl" loading="lazy"/>
            <figcaption class="caption">${cap}${srcHtml}</figcaption>
          </figure>`;
            }
            return `
        <figure class="mt-4">
          <div class="w-full h-56 rounded-xl bg-gray-100 flex items-center justify-center text-gray-500">Image coming soon</div>
        </figure>`;
        }

        // robust chart renderer
        function renderChart(canvas, chart, sectionId, sectionTitle) {
            // labels -> strings
            const labelsAll = Array.isArray(chart.labels) ? chart.labels.map(x => String(x)) : [];

            // build datasets from simple/advanced
            let datasets;
            if (Array.isArray(chart.datasets) && chart.datasets.length) {
                datasets = chart.datasets.map((d, i) => {
                    const data = Array.isArray(d.data) ? d.data.map(Number) : [];
                    const n = Math.min(labelsAll.length, data.length);
                    return {
                        type: d.type || (sectionId === 'payments' ? 'bar' : 'line'),
                        label: d.label || `Series ${i + 1}`,
                        data: data.slice(0, n),
                        yAxisID: d.yAxis || 'y',
                        borderColor: d.borderColor || '#ef233c',
                        backgroundColor: d.backgroundColor || (d.type === 'bar' ? 'rgba(239,35,60,.35)' : 'rgba(239,35,60,.25)'),
                        fill: d.type !== 'bar',
                        tension: d.type !== 'bar' ? 0.35 : 0,
                        pointRadius: d.type !== 'bar' ? 3 : 0
                    };
                });
            } else {
                const data = Array.isArray(chart.data) ? chart.data.map(Number) : [];
                const n = Math.min(labelsAll.length, data.length);
                datasets = [{
                    type: sectionId === 'payments' ? 'bar' : 'line',
                    label: chart.label || sectionTitle || 'Series',
                    data: data.slice(0, n),
                    yAxisID: 'y',
                    borderColor: '#ef233c',
                    backgroundColor: 'rgba(239,35,60,.25)',
                    fill: true, tension: .3, pointRadius: 3
                }];
            }

            // clamp labels to shortest dataset
            const shortest = Math.min(...datasets.map(ds => ds.data.length), labelsAll.length || Infinity);
            const labels = labelsAll.slice(0, shortest);
            datasets = datasets.map(ds => ({ ...ds, data: ds.data.slice(0, shortest) }));

            const defaultType = datasets[0]?.type || 'line';
            const hasRightAxis = datasets.some(d => (d.yAxisID || d.y) === 'y1');
            const yUnit = chart.yUnit || '';
            const y1Unit = chart.y1Unit || '';
            const fmt = (v, u) => u === '%' ? `${v}%` : u === 'M' ? `${v}M` : u === 'S$B' ? `S$${v}B` : v;

            new Chart(canvas, {
                type: defaultType,
                data: { labels, datasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: { label: (ctx) => `${ctx.dataset.label}: ${fmt(ctx.parsed.y, ctx.dataset.yAxisID === 'y1' ? y1Unit : yUnit)}` }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => fmt(v, yUnit) }, grid: { drawOnChartArea: true } },
                        ...(hasRightAxis ? { y1: { beginAtZero: true, position: 'right', ticks: { callback: (v) => fmt(v, y1Unit) }, grid: { drawOnChartArea: false } } } : {})
                    }
                }
            });
        }

        /* ---------------- validate & render ---------------- */
        JSONValidator.validateAndRender({
            url: 'smartnation.json',
            schema: smartNationSchema,
            mountOnErrorId: 'content',
            render: (data) => {
                // NAV + HEADER/FOOTER
                renderNav(data.nav);
                document.getElementById('site-title').textContent = data.site.title || 'Smart Nation';
                document.getElementById('site-subtitle').textContent = data.site.subtitle || '';
                document.getElementById('footer').textContent = data.site.footer || '';

                const main = document.getElementById('content');

                /* ----- Optional top timeline ----- */
                /* ----- Optional top timeline (responsive: horizontal on sm+, vertical on mobile) ----- */
                if (data.timeline?.title && Array.isArray(data.timeline.events)) {
                    const tl = document.createElement('section');
                    tl.className = "sg-card";
                    const events = data.timeline.events;

                    const makeId = (e) => (e.id || e.title || '')
                        .toString()
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-');

                    tl.innerHTML = `
    <h2 class="text-2xl font-bold text-[var(--sg-red)] mb-6 text-center">${data.timeline.title}</h2>

    <!-- Horizontal (sm and up) -->
    <div class="hidden sm:block">
      <div class="relative">
        <div class="absolute left-0 right-0 top-6 h-1 bg-red-100"></div>
        <div class="relative z-10 flex flex-wrap justify-between gap-4">
          ${events.map(e => `
            <a href="#${makeId(e)}" class="flex flex-col items-center text-center">
              <div class="w-6 h-6 rounded-full bg-[var(--sg-red)] border-4 border-white shadow-[0_0_0_2px_#ef233c] mb-2"></div>
              <div class="text-[var(--sg-red)] font-semibold">${e.year || ''}</div>
              <div class="text-sm max-w-[140px]">${e.title || ''}</div>
            </a>
          `).join('')}
        </div>
      </div>
    </div>

    <!-- Vertical (mobile) -->
    <div class="block sm:hidden">
      <ol class="relative border-s-2 border-red-100 ps-4">
        ${events.map(e => `
          <li class="mb-6 ms-2">
            <span class="absolute -start-[9px] mt-1 w-4 h-4 rounded-full bg-[var(--sg-red)] border-4 border-white shadow-[0_0_0_2px_#ef233c]"></span>
            <a href="#${makeId(e)}" class="block">
              <div class="text-[var(--sg-red)] font-semibold">${e.year || ''}</div>
              <div class="text-sm">${e.title || ''}</div>
            </a>
          </li>
        `).join('')}
      </ol>
    </div>

    ${Array.isArray(data.timeline.sources) && data.timeline.sources.length
                            ? `<p class="text-xs text-gray-600 mt-3 text-center sm:text-left">Sources: ${srcLinks(data.timeline.sources)}</p>`
                            : ''}
  `;
                    main.appendChild(tl);
                }


                /* ----- Sections (object map) ----- */
                for (const [id, section] of Object.entries(data.sections || {})) {
                    let html = `<section class="sg-card" id="${id}">
            <h2 class="text-2xl font-bold text-[var(--sg-red)] mb-3">${section.title || ''}</h2>`;

                    (section.paragraphs || []).forEach(p => html += `<p class="mt-3">${p}</p>`);
                    if (section.image) html += renderImageFigure(section.image);

                    if (section.milestones) {
                        html += `<ul class="list-disc ml-6 mt-3">${section.milestones.map(m => `<li>${m}</li>`).join('')}</ul>`;
                    }

                    if (section.stats) {
                        html += `<div class="stat-grid mt-4">${section.stats.map(s => `
              <div class="stat-card">
                <div class="stat-value">${s.value}</div>
                <div class="stat-label">${s.label}</div>
              </div>`).join('')}</div>`;
                    }

                    if (section.features) {
                        html += `<div class="feature-grid mt-4">${section.features.map(f => `
              <div class="feature-card">
                <h3 class="font-bold text-blue-700 mb-2">${f.title}</h3>
                <ul class="list-disc list-inside text-gray-700">
                  ${f.items.map(i => `<li>${i}</li>`).join('')}
                </ul>
              </div>`).join('')}</div>`;
                    }

                    if (section.chart) {
                        const chartId = id + "Chart";
                        html += `
              <div class="w-full overflow-x-auto">
                <canvas id="${chartId}" class="w-full max-w-[900px] min-w-[320px] mt-6" aria-label="${section.title || 'chart'}"></canvas>
              </div>
              ${Array.isArray(section.chart.sources) && section.chart.sources.length ? `<p class="text-xs text-gray-600 mt-2">Sources: ${srcLinks(section.chart.sources)}</p>` : ''}`;
                    }

                    if (section.impact) {
                        html += `<div class="sg-card mt-4 bg-red-50">
              <h3 class="text-xl font-semibold text-red-700 mb-2">${section.impact.title || 'Impact'}</h3>
              <p>${section.impact.text || ''}</p>
              ${Array.isArray(section.impact.achievements) ? `<ul class="list-disc ml-6 mt-2">${section.impact.achievements.map(a => `<li>${a}</li>`).join('')}</ul>` : ''}
              ${section.impact.source ? `<p class="text-xs text-gray-600 italic mt-2">Source: <a class="underline" target="_blank" rel="noopener" href="${section.impact.source.url}">${labelFrom(section.impact.source)}</a></p>` : ''}
            </div>`;
                    }

                    if (section.recognition) {
                        html += `<div class="sg-card mt-4 bg-blue-50">
              <h3 class="text-xl font-semibold text-blue-700 mb-2">${section.recognition.title || 'Recognition'}</h3>
              <p>${section.recognition.text || ''}</p>
              ${section.recognition.source ? `<p class="text-xs text-gray-600 italic mt-2">Source: <a class="underline" target="_blank" rel="noopener" href="${section.recognition.source.url}">${labelFrom(section.recognition.source)}</a></p>` : ''}
            </div>`;
                    }

                    if (section.sources) {
                        html += `<p class="text-xs text-gray-600 mt-3">Sources: ${srcLinks(section.sources)}</p>`;
                    }

                    html += `</section>`;
                    main.insertAdjacentHTML('beforeend', html);

                    if (section.chart) {
                        const canvas = document.getElementById(id + "Chart");
                        renderChart(canvas, section.chart, id, section.title);
                    }
                }

                /* ----- Optional gallery ----- */
                if (data.gallery?.images?.length) {
                    const g = data.gallery;
                    const sec = document.createElement('section');
                    sec.className = 'sg-card';
                    sec.innerHTML = `
            <h2 class="text-2xl font-bold text-[var(--sg-red)] mb-3">${g.title || 'Gallery'}</h2>
            <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-4">
              ${g.images.map(img => `
              <figure class="bg-white rounded-xl border p-3">
  <div class="w-full h-48 flex items-center justify-center bg-gray-50 rounded-md">
    <img src="${img.src}" 
         alt="${img.alt || ''}" 
         class="max-h-full object-contain" 
         loading="lazy"/>
  </div>
  <figcaption class="mt-2 text-sm text-gray-700">
    ${img.caption || ''}
    ${img.source ? `<div class="text-xs text-gray-500">Source: 
      <a class="underline" target="_blank" rel="noopener" href="${img.source.url}">
        ${labelFrom(img.source)}
      </a></div>` : ''}
  </figcaption>
</figure>
              `).join('')}
            </div>`;
                    main.appendChild(sec);
                }
            }
        });
    </script>
</body>

</html>