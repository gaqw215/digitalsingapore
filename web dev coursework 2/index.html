<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Singapore Digital Infrastructure & Smart Nation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --sg-red: #ef233c;
    }

    .sg-card {
      background: #fff;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid #fee2e2;
      box-shadow: 0 5px 12px rgba(0, 0, 0, .08);
    }

    html {
      scroll-behavior: smooth
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans">

  <!-- NAV -->
  <nav id="nav" class="bg-[var(--sg-red)] text-white p-4 shadow-md relative z-50"></nav>

  <!-- HERO -->
  <header class="bg-[var(--sg-red)] text-white p-6 shadow-lg">
    <div class="max-w-6xl mx-auto">
      <h1 id="main-title" class="text-3xl font-extrabold tracking-tight">Loading...</h1>
      <p id="main-subtitle" class="mt-2 text-lg opacity-95"></p>
    </div>
  </header>

  <!-- MAIN -->
  <main id="content" class="max-w-6xl mx-auto p-4 sm:p-6 space-y-12"></main>

  <!-- FOOTER -->
  <footer id="footer" class="bg-gray-100 text-center p-6 text-sm text-gray-600"></footer>

  <!-- validator -->
  <script src="validator.js"></script>
  <script>
    /* ---------------- schema for data.json (now includes citations & section.sources) ---------------- */
    const citationObj = {
      type: 'object',
      required: ['url'],
      properties: {
        url: { type: 'string' },
        name: { type: 'string', optional: true },
        text: { type: 'string', optional: true }
      }
    };

    const paragraphAny = {
      anyOf: [
        { type: 'string' }, // allow simple strings
        {
          type: 'object', required: ['text'], properties: {
            text: { type: 'string' },
            citation: citationObj,                       // single citation
            citations: { type: 'array', items: citationObj } // or multiple citations
          }
        }
      ]
    };

    const indexSchema = {
      type: 'object',
      required: ['nav', 'hero', 'sections', 'footer'],
      properties: {
        nav: {
          type: 'object', required: ['title', 'links'], properties: {
            title: { type: 'string' },
            links: {
              type: 'array', minItems: 1, items: {
                type: 'object', required: ['name', 'url'], properties: {
                  name: { type: 'string' }, url: { type: 'string' }, active: { type: 'boolean', optional: true }
                }
              }
            }
          }
        },
        hero: {
          type: 'object', required: ['title', 'subtitle'], properties: {
            title: { type: 'string' }, subtitle: { type: 'string' }
          }
        },
        sections: {
          type: 'array', minItems: 1, items: {
            type: 'object', required: ['id', 'title'], properties: {
              id: { type: 'string' }, title: { type: 'string' },
              paragraphs: { type: 'array', items: paragraphAny },
              lists: { type: 'array', optional: true, items: { type: 'string' } },
              sources: { type: 'array', optional: true, items: citationObj }
            }
          }
        },
        footer: { type: 'object', required: ['text'], properties: { text: { type: 'string' } } }
      }
    };

    /* ---------------- helpers ---------------- */
    function renderNav(navData) {
      const nav = document.getElementById('nav');
      nav.innerHTML = `
        <div class="max-w-6xl mx-auto flex items-center justify-between">
          <a href="index.html" class="font-bold text-xl">${navData.title}</a>
          <button id="menu-btn" class="sm:hidden p-2 rounded focus:outline-none" aria-expanded="false" aria-controls="menu" aria-label="Toggle menu">☰</button>
          <ul id="menu" class="hidden sm:flex gap-6 absolute sm:static top-full left-0 right-0 bg-[var(--sg-red)] sm:bg-transparent flex-col sm:flex-row p-4 sm:p-0 shadow-md sm:shadow-none">
            ${navData.links.map(l => `<li><a href="${l.url}" class="block py-2 sm:py-0 ${l.active ? 'underline' : 'hover:underline'}">${l.name}</a></li>`).join('')}
          </ul>
        </div>`;
      const btn = nav.querySelector('#menu-btn');
      const menu = nav.querySelector('#menu');
      btn?.addEventListener('click', () => {
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!expanded));
        menu.classList.toggle('hidden');
      });
      menu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => {
        if (window.innerWidth < 640) { menu.classList.add('hidden'); btn?.setAttribute('aria-expanded', 'false'); }
      }));
    }

    // render a list of sources (accepts {text|name,url})
    function srcLinks(arr) {
      return (arr || [])
        .map(s => {
          const label = (s && (s.text || s.name)) ? (s.text || s.name) : 'source';
          const url = s && s.url ? s.url : '#';
          return `<a class="underline" target="_blank" rel="noopener" href="${url}">${label}</a>`;
        })
        .join(' • ');
    }

    // render a single paragraph which might have inline citations
    function renderParagraph(p) {
      if (typeof p === 'string') {
        return `<p class="mt-3">${p}</p>`;
      }
      const text = p.text || '';
      let cite = '';
      if (p.citation) {
        const c = p.citation;
        const label = c.text || c.name || 'source';
        cite = ` <cite class="text-xs text-gray-500">Source: <a class="underline" target="_blank" rel="noopener" href="${c.url}">${label}</a></cite>`;
      } else if (Array.isArray(p.citations) && p.citations.length) {
        cite = ` <cite class="text-xs text-gray-500">Sources: ${srcLinks(p.citations)}</cite>`;
      }
      return `<p class="mt-3">${text}${cite}</p>`;
    }

    /* ---------------- validate & render ---------------- */
    JSONValidator.validateAndRender({
      url: 'data.json',
      schema: indexSchema,
      mountOnErrorId: 'content',
      render: (data) => {
        // NAV + HERO
        renderNav(data.nav);
        document.getElementById('main-title').textContent = data.hero.title;
        document.getElementById('main-subtitle').textContent = data.hero.subtitle;

        // SECTIONS
        const main = document.getElementById('content');
        (data.sections || []).forEach(sec => {
          let html = `<section class="sg-card" id="${sec.id}">
            <h2 class="text-2xl font-bold text-[var(--sg-red)]">${sec.title}</h2>`;

          // paragraphs (string or {text, citation(s)})
          (sec.paragraphs || []).forEach(p => {
            html += renderParagraph(p);
          });

          // optional bullet list
          if (Array.isArray(sec.lists) && sec.lists.length) {
            html += `<ul class="list-disc list-inside space-y-2 mt-3">
              ${sec.lists.map(li => `<li>${li}</li>`).join('')}
            </ul>`;
          }

          // section-level sources
          if (Array.isArray(sec.sources) && sec.sources.length) {
            html += `<p class="text-xs text-gray-600 mt-3">Sources: ${srcLinks(sec.sources)}</p>`;
          }

          html += `</section>`;
          main.insertAdjacentHTML('beforeend', html);
        });

        // FOOTER
        document.getElementById('footer').textContent = data.footer.text;
      }
    });
  </script>
</body>

</html>